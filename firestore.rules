rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Deny all access by default
    match /{document=**} {
      allow read, write: if false;
    }

    // Allow users to read, create, update, and delete their own properties
    match /properties/{propertyId} {
      allow read, create, update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Allow users to read their own user data
    match /users/{userId} {
        allow read: if request.auth != null && request.auth.uid == userId;

        // Allow users to manage their own notification tokens
        match /tokens/{tokenId} {
            allow read, write: if request.auth != null && request.auth.uid == userId;
        }
    }

    // Allow users to manage tenants associated with their properties
    match /tenants/{tenantId} {
        allow read, create, update, delete: if request.auth != null && request.auth.uid == get(/databases/$(database)/documents/properties/$(resource.data.propertyId)).data.userId;
    }

    // Allow users to manage payments associated with their tenants
    match /payments/{paymentId} {
        allow read, create, update, delete: if request.auth != null && request.auth.uid == get(/databases/$(database)/documents/tenants/$(resource.data.tenantId)).data.userId;
    }
  }
}
